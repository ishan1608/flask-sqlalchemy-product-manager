<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Products Import</title>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet"/>
    <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet" media="screen"/>
    <link href="{{ url_for('static', filename='css/toastr.min.css') }}" rel="stylesheet" media="screen"/>

    <script type="text/javascript" src="{{ url_for('static', filename='js/jquery-3.3.1.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/underscore.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/toastr.min.js') }}"></script>

    <script type="text/javascript" src="{{ url_for('static', filename='js/util.js') }}"></script>
</head>
<body>
<div class="container">
    <h1>{% if active_mode %}Active{% else %}Inactive{% endif %} Products (<span id="start-position"></span> -- <span id="end-position"></span>)</h1>
    <ul id="products-list"></ul>

    <nav aria-label="Page navigation example">
        <ul class="pagination">
            <li class="page-item"><a id="previous-link" class="page-link" href="#">Previous</a></li>
            <li class="page-item"><a id="next-link" class="page-link" href="#">Next</a></li>
        </ul>
    </nav>
</div>
<script type="text/html" id="ProductTmpl">
    <li>
        <p>Name: <input type="text" name="name" value="<%= name %>"/></p>
        <p>SKU: <input type="text" name="sku" value="<%= sku %>"/></p>
        <p>Description: <input type="text" name="description" value="<%= description %>"/></p>
        <p>Is Active: <input type="checkbox" name="is_active" <%= is_active ? 'checked' : '' %>/></p>
        <input type="submit" value="Update" name="submit" data-id="<%= id %>"/>
    </li>
</script>
<script type="text/javascript">
    $(function () {
        // Initialize Toastr Options
        toastr.options = {
            'closeButton': true,
            'debug': false,
            'newestOnTop': true,
            'progressBar': false,
            'positionClass': 'toast-top-right',
            'preventDuplicates': false,
            'onclick': null,
            'showDuration': '300',
            'hideDuration': '1000',
            'timeOut': '5000',
            'extendedTimeOut': '1000',
            'showEasing': 'swing',
            'hideEasing': 'linear',
            'showMethod': 'fadeIn',
            'hideMethod': 'fadeOut'
        };


        let offset = getUrlParameter('offset');
        offset = isNaN(offset) ? 0 : parseInt(offset);
        let limit = getUrlParameter('limit');
        limit = isNaN(limit) ? 10 : parseInt(limit);

        // Display Products
        $.ajax({
            method: 'GET',
            url: {{ url_for('productresourcelist') }} + '?is_active={{ active_mode }}&offset=' + offset + '&limit=' + limit,
        }).done(function (data) {
            $('#start-position').text(data.meta.offset <= data.meta.total_count ? data.meta.offset : data.meta.total_count);
            let endCount = data.meta.offset + data.meta.count;
            $('#end-position').text(endCount <= data.meta.total_count ? endCount : data.meta.total_count);

            let productsList = $('#products-list');
            _.each(data.objects, function (object) {
                productsList.append(_.template($('#ProductTmpl').html())(object));
            });

            if (data.meta.previous) {
                $('#previous-link').attr('href', window.location.pathname + '?offset=' + (offset - limit) + '&limit=' + limit);
            } else {
                $('#previous-link').css('visibility', 'hidden');
            }

            if (data.meta.next) {
                $('#next-link').attr('href', window.location.pathname + '?offset=' + (offset + limit) + '&limit=' + limit);
            } else {
                $('#next-link').css('visibility', 'hidden');
            }

            registerUpdateListener();
        });
    });

    let registerUpdateListener = function() {
        // Update Product
        $(':input[name="submit"]').on('click', function(event) {
            event.preventDefault();
            event.stopPropagation();

            let $elem = $(event.currentTarget);
            let productId = $elem.attr('data-id');

            let $productContainer = $elem.parent().parent();
            let productName = $productContainer.find(':input[name="name"]').val();
            let productSku = $productContainer.find(':input[name="sku"]').val();
            let productDescription = $productContainer.find(':input[name="description"]').val();
            let productIsActive = $productContainer.find(':input[name="is_active"]').is('checked');

            $.ajax({
                method: 'PUT',
                url: {{ url_for('productresourcelist') }} + productId +'/',
                data: {
                    id: productId,
                    is_active: productIsActive,
                    name: productName,
                    sku: productSku,
                    description: productDescription
                }
            }).done(function (data) {
                toastr['success']('Product ' + productId + ' Updated', 'Success');
            }).fail(function() {
                toastr["error"]('Failed Updating Product ' + productId, "Success")
            });
        });
    };
</script>
</body>
</html>
